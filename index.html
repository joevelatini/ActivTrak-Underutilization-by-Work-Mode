<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ActivTrak Underutilization by Work Mode</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 2px solid #0070cd;
            margin-bottom: 20px;
        }
        .logo {
            display: flex;
            align-items: center;
        }
        .logo-icon {
            margin-right: 12px;
            width: 60px;
            height: 60px;
        }
        h1, h2, h3 {
            color: #333;
            margin-top: 0;
        }
        .settings {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .file-upload {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #0070cd;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover {
            background-color: #00529b;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .demo-button {
            background-color: #00529b;
            margin-left: 10px;
        }
        .reset-button:hover {
            background-color: #5a6268;
        }
        .metrics-container {
            margin: 30px 0;
        }
        .location-row {
            display: flex;
            align-items: center;
            border-bottom: 1px dotted #ccc;
            padding: 15px 0;
        }
        .location-row:last-child {
            border-bottom: none;
        }
        .location-label {
            width: 130px;
            font-weight: bold;
        }
        .bar-container {
            flex: 1;
            margin: 0 20px;
        }
        .bar {
            height: 34px;
            background-color: #0070cd;
            display: flex;
            align-items: center;
            color: white;
            padding: 0 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        .metrics {
            width: 140px;
            text-align: right;
        }
        .percentage {
            text-align: right;
            width: 80px;
            font-weight: bold;
        }
        .fte {
            font-weight: bold;
        }
        .cost {
            color: #d32f2f;
            font-weight: bold;
        }
        .insights {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        .insights ul {
            margin: 0;
            padding-left: 20px;
        }
        .insights li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .map-icon {
            margin-left: 12px;
            width: 40px;
            height: 40px;
        }
        .footer {
            text-align: center;
            font-size: 12px;
            color: #777;
            margin-top: 30px;
        }
        .error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin-bottom: 20px;
            color: #d32f2f;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            font-weight: 600;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        .hidden {
            display: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #0070cd;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .text-right {
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                        <!-- ActivTrak logo styled triangles -->
                        <polygon points="100,20 30,130 170,130" fill="#0070CD" />
                        <polygon points="80,60 40,130 120,130" fill="#00B2A9" />
                        <polygon points="80,90 60,130 100,130" fill="#2D3E50" />
                    </svg>
                </div>
                <h1>ActivTrak Underutilization by Work Mode</h1>
                <div class="map-icon">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 010-5 2.5 2.5 0 010 5z" fill="#0070CD"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="settings">
            <h2>Analysis Settings</h2>
            <div style="display: flex; gap: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label for="productivityGoal">Productivity Goal (hours/day)</label>
                    <input type="number" id="productivityGoal" min="1" max="24" step="0.1" value="7.5">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="annualSalary">Annual Salary for Cost Calculation ($)</label>
                    <input type="number" id="annualSalary" min="10000" step="1000" value="60000">
                </div>
            </div>
        </div>

        <!-- File Upload -->
        <div class="file-upload">
            <h2>Upload and Configure Data</h2>
            <div class="form-group">
                <label for="csvFile">Upload CSV File</label>
                <div style="display: flex; gap: 10px;">
                    <input type="file" id="csvFile" accept=".csv">
                    <button id="demoButton" class="demo-button">Use Sample Data</button>
                </div>
            </div>
            
            <div id="columnSelectors" class="hidden">
                <div style="display: flex; gap: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="locationColumn">Location/Work Mode Column</label>
                        <select id="locationColumn">
                            <option value="">-- Select Column --</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="productiveHoursColumn">Productive Hours Column</label>
                        <select id="productiveHoursColumn">
                            <option value="">-- Select Column --</option>
                        </select>
                    </div>
                </div>
                <div class="button-group">
                    <button id="analyzeButton" disabled>Analyze Data</button>
                    <button id="resetButton" class="reset-button" style="background-color: #6c757d;">Reset</button>
                </div>
            </div>
        </div>

        <!-- Error message -->
        <div id="errorContainer" class="error hidden"></div>

        <!-- Loading indicator -->
        <div id="loadingContainer" class="loading hidden">
            Processing data...
        </div>

        <!-- Results container -->
        <div id="resultsContainer" class="hidden">
            <h2>Work Mode Analysis Results</h2>
            
            <div class="metrics-container">
                <h3>Location Summary</h3>
                <div id="locationRows">
                    <!-- Location rows will be inserted here -->
                </div>
            </div>
            
            <div class="insights">
                <h3>Key Insights</h3>
                <ul id="insightsList">
                    <!-- Insights will be inserted here -->
                </ul>
            </div>
            
            <!-- Data Sample -->
            <h3>Data Sample (First 10 Records)</h3>
            <div style="overflow-x: auto;">
                <table id="sampleTable">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Location</th>
                            <th class="text-right">Productive Hours</th>
                            <th class="text-right">Target</th>
                            <th class="text-right">Delta</th>
                        </tr>
                    </thead>
                    <tbody id="sampleTableBody">
                        <!-- Sample data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="footer">
            ActivTrak Underutilization by Work Mode | Data analysis based on CSV upload
        </div>
    </div>

    <script>
        // Main variables
        let data = [];
        let headers = [];
        let selectedColumns = {
            location: '',
            productiveHours: ''
        };
        let analysisResults = null;
        
        // DOM elements
        const productivityGoalInput = document.getElementById('productivityGoal');
        const annualSalaryInput = document.getElementById('annualSalary');
        const csvFileInput = document.getElementById('csvFile');
        const demoButton = document.getElementById('demoButton');
        const columnSelectors = document.getElementById('columnSelectors');
        const locationColumnSelect = document.getElementById('locationColumn');
        const productiveHoursColumnSelect = document.getElementById('productiveHoursColumn');
        const analyzeButton = document.getElementById('analyzeButton');
        const resetButton = document.getElementById('resetButton');
        const errorContainer = document.getElementById('errorContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const resultsContainer = document.getElementById('resultsContainer');
        
        // Event listeners
        csvFileInput.addEventListener('change', handleFileUpload);
        demoButton.addEventListener('click', useSampleData);
        locationColumnSelect.addEventListener('change', updateAnalyzeButtonState);
        productiveHoursColumnSelect.addEventListener('change', updateAnalyzeButtonState);
        analyzeButton.addEventListener('click', analyzeData);
        resetButton.addEventListener('click', resetApplication);
        
        // Functions
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            loadingContainer.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    loadingContainer.classList.add('hidden');
                    
                    if (results.data && results.data.length > 0) {
                        data = results.data;
                        headers = results.meta.fields;
                        populateColumnSelectors();
                        columnSelectors.classList.remove('hidden');
                    } else {
                        showError("No data found in the CSV file.");
                    }
                },
                error: function(error) {
                    loadingContainer.classList.add('hidden');
                    showError(`Error parsing CSV: ${error.message}`);
                }
            });
        }
        
        function populateColumnSelectors() {
            // Clear existing options except the first one
            while (locationColumnSelect.options.length > 1) {
                locationColumnSelect.remove(1);
            }
            
            while (productiveHoursColumnSelect.options.length > 1) {
                productiveHoursColumnSelect.remove(1);
            }
            
            // Add new options
            headers.forEach(header => {
                const locationOption = document.createElement('option');
                locationOption.value = header;
                locationOption.textContent = header;
                locationColumnSelect.appendChild(locationOption);
                
                const productiveOption = document.createElement('option');
                productiveOption.value = header;
                productiveOption.textContent = header;
                productiveHoursColumnSelect.appendChild(productiveOption);
            });
        }
        
        function updateAnalyzeButtonState() {
            selectedColumns.location = locationColumnSelect.value;
            selectedColumns.productiveHours = productiveHoursColumnSelect.value;
            
            analyzeButton.disabled = !selectedColumns.location || !selectedColumns.productiveHours;
        }
        
        function showError(message) {
            errorContainer.textContent = message;
            errorContainer.classList.remove('hidden');
        }
        
        function analyzeData() {
            loadingContainer.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            
            const productivityGoal = parseFloat(productivityGoalInput.value);
            const annualSalary = parseFloat(annualSalaryInput.value);
            
            try {
                // Process the data
                const employeeData = data.map((row, index) => {
                    const location = row[selectedColumns.location] || 'Unknown';
                    const productiveHours = parseFloat(row[selectedColumns.productiveHours]) || 0;
                    const delta = productivityGoal - productiveHours; // Positive delta means under goal
                    
                    return {
                        employeeId: `Emp${index + 1}`,
                        location,
                        productiveHours,
                        delta
                    };
                });
                
                // Group by location
                const grouped = _.groupBy(employeeData, 'location');
                
                // Calculate metrics for each location
                const locations = Object.keys(grouped).map(location => {
                    const employees = grouped[location];
                    const count = employees.length;
                    const percentage = ((count / employeeData.length) * 100).toFixed(1);
                    
                    // Calculate total delta hours (positive values only - underperforming)
                    const deltaHours = employees.reduce((sum, emp) => sum + Math.max(0, emp.delta), 0);
                    
                    // Calculate FTE and cost
                    const fte = Math.round(deltaHours / 8);
                    const monthlyCost = Math.round((deltaHours / 8) * (annualSalary / 12));
                    
                    return {
                        location,
                        count,
                        percentage,
                        deltaHours: deltaHours.toFixed(2),
                        fte,
                        monthlyCost
                    };
                });
                
                // Sort locations by count (descending)
                const sortedLocations = _.sortBy(locations, loc => -loc.count);
                
                // Set the results
                analysisResults = {
                    locations: sortedLocations,
                    totalEmployees: employeeData.length,
                    employeeData: employeeData.slice(0, 10) // Just include first 10 for sample
                };
                
                // Display the results
                displayResults();
                
            } catch (err) {
                loadingContainer.classList.add('hidden');
                showError(`Analysis error: ${err.message}`);
            }
        }
        
        function displayResults() {
            if (!analysisResults) return;
            
            // Update location rows
            const locationRows = document.getElementById('locationRows');
            locationRows.innerHTML = '';
            
            // Find max count for scaling bars
            const maxCount = Math.max(...analysisResults.locations.map(loc => loc.count));
            
            analysisResults.locations.forEach(location => {
                const row = document.createElement('div');
                row.className = 'location-row';
                
                // Calculate width percentage (max 85%)
                const widthPercentage = Math.min(85, (location.count / maxCount) * 85);
                
                row.innerHTML = `
                    <div class="location-label">${location.location}</div>
                    <div class="bar-container">
                        <div class="bar" style="width: ${widthPercentage}%">${location.count}</div>
                    </div>
                    <div class="percentage">${location.percentage}%</div>
                    <div class="metrics">
                        <div class="fte">${location.fte} FTE</div>
                        <div class="cost">$${location.monthlyCost.toLocaleString()}</div>
                    </div>
                `;
                
                locationRows.appendChild(row);
            });
            
            // Update insights
            const insightsList = document.getElementById('insightsList');
            insightsList.innerHTML = '';
            
            // Generate insights
            let insights = [];
            
            // Sort locations by productivity (highest delta first)
            const productivitySorted = _.sortBy(analysisResults.locations, loc => -parseFloat(loc.deltaHours)/loc.count);
            
            // Add insights based on the data
            if (productivitySorted.length > 0) {
                const leastProductive = productivitySorted[0].location;
                const mostProductive = productivitySorted[productivitySorted.length - 1].location;
                
                insights = [
                    `Employees working in <strong>${leastProductive}</strong> mode show the lowest average productivity`,
                    `<strong>${mostProductive}</strong> workers demonstrate the highest productivity levels`,
                    `The largest potential for improvement is in the <strong>${leastProductive}</strong> category (${productivitySorted[0].fte} FTE, $${productivitySorted[0].monthlyCost.toLocaleString()})`,
                    `${analysisResults.locations.reduce((sum, loc) => sum + loc.fte, 0)} total FTE of untapped productivity potential across all work modes`,
                    `Addressing productivity gaps would save approximately $${analysisResults.locations.reduce((sum, loc) => sum + loc.monthlyCost, 0).toLocaleString()} monthly`
                ];
                
                // Add remote vs office comparison if both exist
                const hasOffice = analysisResults.locations.some(loc => 
                    loc.location.toLowerCase().includes('office'));
                const hasRemote = analysisResults.locations.some(loc => 
                    loc.location.toLowerCase().includes('remote'));
                
                if (hasOffice && hasRemote) {
                    insights.push('Employees with some remote ability seem more productive overall compared to office-only staff');
                }
            }
            
            // Add insights to the list
            insights.forEach(insight => {
                const li = document.createElement('li');
                li.innerHTML = insight;
                insightsList.appendChild(li);
            });
            
            // Update sample data
            const sampleTableBody = document.getElementById('sampleTableBody');
            sampleTableBody.innerHTML = '';
            
            analysisResults.employeeData.forEach((employee, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${employee.employeeId}</td>
                    <td>${employee.location}</td>
                    <td class="text-right">${employee.productiveHours.toFixed(2)}</td>
                    <td class="text-right">${productivityGoalInput.value}</td>
                    <td class="text-right">${employee.delta.toFixed(2)}</td>
                `;
                
                sampleTableBody.appendChild(row);
            });
            
            // Show results
            resultsContainer.classList.remove('hidden');
            loadingContainer.classList.add('hidden');
        }
        
        function useSampleData() {
            loadingContainer.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            
            // Clear file input
            csvFileInput.value = '';
            
            // Create sample data
            const sampleData = [
                { Location: 'Office Only', ProductiveHours: 5.2 },
                { Location: 'Office Only', ProductiveHours: 4.7 },
                { Location: 'Office Only', ProductiveHours: 5.5 },
                { Location: 'Office Only', ProductiveHours: 4.9 },
                { Location: 'Office Only', ProductiveHours: 5.3 },
                { Location: 'Office Only', ProductiveHours: 4.5 },
                { Location: 'Office Only', ProductiveHours: 5.0 },
                { Location: 'Office Only', ProductiveHours: 5.4 },
                { Location: 'Office Only', ProductiveHours: 4.6 },
                { Location: 'Office Only', ProductiveHours: 5.1 },
                { Location: 'Office Only', ProductiveHours: 5.0 },
                { Location: 'Office Only', ProductiveHours: 4.8 },
                { Location: 'Office Only', ProductiveHours: 5.2 },
                { Location: 'Office Only', ProductiveHours: 4.7 },
                { Location: 'Office Only', ProductiveHours: 5.3 },
                { Location: 'Office Only', ProductiveHours: 5.5 },
                { Location: 'Office Only', ProductiveHours: 4.9 },
                { Location: 'Office Only', ProductiveHours: 5.1 },
                { Location: 'Office Only', ProductiveHours: 4.8 },
                { Location: 'Office Only', ProductiveHours: 5.0 },
                { Location: 'Office Only', ProductiveHours: 5.2 },
                { Location: 'Office Only', ProductiveHours: 4.7 },
                { Location: 'Office Only', ProductiveHours: 5.5 },
                { Location: 'Office Only', ProductiveHours: 4.9 },
                { Location: 'Office Only', ProductiveHours: 5.1 },
                { Location: 'Office Only', ProductiveHours: 4.6 },
                { Location: 'Office Only', ProductiveHours: 5.3 },
                { Location: 'Office Only', ProductiveHours: 4.8 },
                { Location: 'Office Only', ProductiveHours: 5.0 },
                { Location: 'Office Only', ProductiveHours: 5.5 },
                { Location: 'Office Only', ProductiveHours: 4.9 },
                { Location: 'Office Only', ProductiveHours: 5.3 },
                { Location: 'Office Only', ProductiveHours: 4.7 },
                { Location: 'Office Only', ProductiveHours: 5.1 },
                { Location: 'Office Only', ProductiveHours: 5.5 },
                { Location: 'Office Only', ProductiveHours: 4.9 },
                { Location: 'Office Only', ProductiveHours: 5.2 },
                { Location: 'Office Only', ProductiveHours: 4.7 },
                { Location: 'Office Only', ProductiveHours: 5.3 },
                { Location: 'Office Only', ProductiveHours: 4.8 },
                { Location: 'Office Only', ProductiveHours: 5.0 },
                { Location: 'Office Only', ProductiveHours: 5.4 },
                { Location: 'Office Only', ProductiveHours: 4.6 },
                { Location: 'Office Only', ProductiveHours: 5.2 },
                { Location: 'Office Only', ProductiveHours: 4.9 },
                { Location: 'Office Only', ProductiveHours: 5.1 },
                { Location: 'Office Only', ProductiveHours: 4.7 },
                { Location: 'Office Only', ProductiveHours: 5.3 },
                { Location: 'Office Only', ProductiveHours: 4.8 },
                { Location: 'Office Only', ProductiveHours: 5.0 },
                { Location: 'Office Only', ProductiveHours: 5.4 },
                { Location: 'Office Only', ProductiveHours: 4.9 },
                { Location: 'Office Only', ProductiveHours: 5.2 },
                { Location: 'Office Only', ProductiveHours: 5.0 },
                { Location: 'Office Only', ProductiveHours: 4.8 },
                { Location: 'Office Only', ProductiveHours: 5.1 },
                { Location: 'Office Only', ProductiveHours: 4.7 },
                { Location: 'Office Only', ProductiveHours: 5.3 },
                { Location: 'Office Only', ProductiveHours: 5.0 },
                
                { Location: 'Hybrid', ProductiveHours: 6.5 },
                { Location: 'Hybrid', ProductiveHours: 6.8 },
                { Location: 'Hybrid', ProductiveHours: 6.2 },
                { Location: 'Hybrid', ProductiveHours: 6.7 },
                { Location: 'Hybrid', ProductiveHours: 6.4 },
                { Location: 'Hybrid', ProductiveHours: 6.9 },
                { Location: 'Hybrid', ProductiveHours: 6.3 },
                
                { Location: 'Remote Only', ProductiveHours: 6.9 },
                { Location: 'Remote Only', ProductiveHours: 7.1 },
                { Location: 'Remote Only', ProductiveHours: 6.7 },
                { Location: 'Remote Only', ProductiveHours: 6.4 },
                { Location: 'Remote Only', ProductiveHours: 7.0 },
                { Location: 'Remote Only', ProductiveHours: 6.8 },
                { Location: 'Remote Only', ProductiveHours: 6.5 },
                { Location: 'Remote Only', ProductiveHours: 7.2 },
                { Location: 'Remote Only', ProductiveHours: 6.6 },
                { Location: 'Remote Only', ProductiveHours: 6.9 },
                { Location: 'Remote Only', ProductiveHours: 7.0 }
            ];
            
            // Set data and display column selectors
            data = sampleData;
            headers = Object.keys(sampleData[0]);
            
            // Clear existing options except the first one
            while (locationColumnSelect.options.length > 1) {
                locationColumnSelect.remove(1);
            }
            
            while (productiveHoursColumnSelect.options.length > 1) {
                productiveHoursColumnSelect.remove(1);
            }
            
            // Add new options
            headers.forEach(header => {
                const locationOption = document.createElement('option');
                locationOption.value = header;
                locationOption.textContent = header;
                locationColumnSelect.appendChild(locationOption);
                
                const productiveOption = document.createElement('option');
                productiveOption.value = header;
                productiveOption.textContent = header;
                productiveHoursColumnSelect.appendChild(productiveOption);
            });
            
            // Auto-select correct columns
            locationColumnSelect.value = 'Location';
            productiveHoursColumnSelect.value = 'ProductiveHours';
            updateAnalyzeButtonState();
            
            columnSelectors.classList.remove('hidden');
            loadingContainer.classList.add('hidden');
        }
        
        // Reset function to start over
        function resetApplication() {
            // Clear the file input
            csvFileInput.value = '';
            
            // Reset data arrays
            data = [];
            headers = [];
            
            // Reset selected columns
            selectedColumns = {
                location: '',
                productiveHours: ''
            };
            
            // Reset column selectors
            while (locationColumnSelect.options.length > 1) {
                locationColumnSelect.remove(1);
            }
            
            while (productiveHoursColumnSelect.options.length > 1) {
                productiveHoursColumnSelect.remove(1);
            }
            
            // Reset selections
            locationColumnSelect.selectedIndex = 0;
            productiveHoursColumnSelect.selectedIndex = 0;
            
            // Disable analyze button
            analyzeButton.disabled = true;
            
            // Hide results and column selectors
            resultsContainer.classList.add('hidden');
            columnSelectors.classList.add('hidden');
            errorContainer.classList.add('hidden');
            
            // Reset analysis results
            analysisResults = null;
        }
    </script>
</body>
</html>
